<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>NeoPixel Caveats | CDEFO</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="NeoPixel Caveats" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Premiere Emotional UbiComp Emulator" />
<meta property="og:description" content="The Premiere Emotional UbiComp Emulator" />
<link rel="canonical" href="http://localhost:4000/CDEFO/_pages/tutorial/05_light_config.html" />
<meta property="og:url" content="http://localhost:4000/CDEFO/_pages/tutorial/05_light_config.html" />
<meta property="og:site_name" content="CDEFO" />
<script type="application/ld+json">
{"url":"http://localhost:4000/CDEFO/_pages/tutorial/05_light_config.html","headline":"NeoPixel Caveats","description":"The Premiere Emotional UbiComp Emulator","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <link rel="stylesheet" href="/CDEFO/assets/css/style.css?v=">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">CDEFO</h1>
      <h2 class="project-tagline">The Premiere Emotional UbiComp Emulator</h2>
      	<a href="/CDEFO/" class="btn">Home</a>
		<a href="/CDEFO/about/" class="btn">About</a>
		<a href="/CDEFO/doc/" class="btn">Docs</a>
		<a href="/CDEFO/tut/" class="btn">Tutorial</a>
		<a href="/CDEFO/log/" class="btn">Build Log</a>
	  
	  <a href="/CDEFO/blog/" class="btn">Blog</a>
      
    </section>

    <section class="main-content">
      <h1>NeoPixel Caveats</h1>
 
    <h3 id="software">Software:</h3>

<p>In order to keep everything static, the LEDs have two components. There’s the NeoPixel LED Object instantiated in the Driver Sketch like so…</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include &lt;CDEFO.h&gt; % note that the AdaFruit_NeoPixel library is already included in CDEFO.h
#define MOOD_PIN  6
#define MOOD_LEDS 16
</span>
<span class="n">Adafruit_NeoPixel</span> <span class="n">mood</span> <span class="o">=</span> <span class="n">Adafruit_NeoPixel</span><span class="p">(</span><span class="n">MOOD_LEDS</span><span class="p">,</span> <span class="n">MOOD_PIN</span><span class="p">,</span> <span class="n">NEO_GRB</span> <span class="o">+</span> <span class="n">NEO_KHZ800</span><span class="p">);</span></code></pre></figure>

<p>And there’s the LED Structure, which contains pointers to all of the variables that the LED strips could possibly use. It looks something like this…</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="c1">//STRUCTURE FOR EQ</span>
	<span class="kt">uint16_t</span> <span class="n">gradient</span><span class="p">;</span> <span class="c1">//Used to iterate and loop through each color palette gradually</span>

	<span class="kt">float</span> <span class="n">maxVol</span><span class="p">;</span>    <span class="c1">//Holds the largest volume recorded thus far to proportionally adjust the visual's responsiveness.</span>
	<span class="kt">float</span> <span class="n">avgBump</span><span class="p">;</span>    <span class="c1">//Holds the "average" volume-change to trigger a "bump."</span>

	<span class="kt">uint8_t</span> <span class="n">volume</span><span class="p">;</span>   <span class="c1">//Holds the volume level read from the sound detector.</span>
	<span class="kt">uint8_t</span> <span class="n">last</span><span class="p">;</span>     <span class="c1">//Holds the value of volume from the previous loop() pass.</span>

	<span class="kt">uint8_t</span> <span class="n">palette</span><span class="p">;</span>  <span class="c1">//Holds the current color palette.</span>

	<span class="kt">bool</span> <span class="n">bump</span><span class="p">;</span>     <span class="c1">//Used to pass if there was a "bump" in volume</span>

	<span class="c1">//STRUCTURE FOR MOOD</span>
	<span class="kt">uint32_t</span> <span class="n">start_col</span><span class="p">;</span> <span class="c1">//used to store the "greeting" color for each experience</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">mini</span><span class="p">;</span> <span class="c1">//used to store the lighting scripts</span>

	<span class="kt">int</span> <span class="n">light_number</span><span class="p">;</span> <span class="c1">//stores the number of lighting scripts to store</span>
	<span class="kt">int</span> <span class="n">light_pointer</span><span class="p">;</span> <span class="c1">//checks which script is executing</span>
	<span class="kt">int</span> <span class="n">light2_pointer</span><span class="p">;</span> <span class="c1">//checks which portion of each script is executing</span>


	<span class="kt">uint32_t</span> <span class="n">c</span><span class="p">;</span> <span class="c1">//stores which color the script is using</span>
	<span class="kt">uint32_t</span> <span class="n">b</span><span class="p">;</span> <span class="c1">//breathe light</span>
	<span class="kt">int</span> <span class="n">finish2</span><span class="p">;</span> <span class="c1">//stores the execution state of each individual colors in the script and whether its finished</span>
	<span class="kt">int</span> <span class="n">finish</span><span class="p">;</span> <span class="c1">//stores the executiong state of each full script</span>
	<span class="kt">int</span> <span class="n">led_pointer</span><span class="p">;</span> <span class="c1">//controls the location of the actual LED</span>

	<span class="kt">char</span> <span class="n">lighting_pattern</span><span class="p">;</span>

	<span class="kt">double</span> <span class="n">scale</span><span class="p">;</span> <span class="c1">//keeps track of the intensity of each pixel during breathe</span>

	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">colors_init</span><span class="p">;</span> <span class="c1">// used to store each script color separately</span>

	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">twinkle_array</span><span class="p">;</span> <span class="c1">//stores the colors to be used in twinkle</span>
	<span class="kt">uint32_t</span> <span class="n">twinkle_num</span><span class="p">;</span> <span class="c1">//number of colors that twinkle</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time_now</span><span class="p">;</span> <span class="c1">//used to bake in delays</span>
<span class="p">}</span> <span class="n">LED</span><span class="p">;</span></code></pre></figure>

<p>By having everything contained within this structure and calling variables through their pointers instead of passing them by copies,
I am able to prevent the creation of new blocks of memory, 
and subsequently prevent massive amounts of internal memory fragmentation that could potentially crash the Arduino.
I have found that this massively improves stability at the cost of only a few extra clock cycles.</p>

<h3 id="hardware">Hardware</h3>

<p>Hardware wise, you only need to make sure that the LED strips you’re using have strong enough pads,
otherwise you’ll end up with all sorts of loose ground connections, data connections.
Loose connections were by far was the biggest issue I ran into over the course of the project…</p>

<figure>
        <img src="/CDEFO/_assets/images/badpads.jpg" />
        <figcaption>See, looks how bad these pads got. They literally have holes in them and you don't even know it until you pry them off manually</figcaption>
</figure>

<p>This easily resulted at least 70 hours worth of debugging and lab time. This can be offset by soldering the wires a little further up the strip as to alleviate any torque, like so…</p>

<figure>
        <img src="/CDEFO/_assets/images/goodpads.jpg" />
        <figcaption>The data cable here is still at risk of tearing off, but I found that didn't happen nearly as often as the 5V and GND</figcaption>
</figure>












      <footer class="site-footer">
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
		<span class="site-footer-contact"><a href="/CDEFO/contact">Contact Page</a>.</span>
	  </footer>
    </section>

    
  </body>
</html>
