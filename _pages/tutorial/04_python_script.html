<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Setting Up the Python Script | CDEFO</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Setting Up the Python Script" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Premiere Emotional UbiComp Emulator" />
<meta property="og:description" content="The Premiere Emotional UbiComp Emulator" />
<link rel="canonical" href="http://localhost:4000/CDEFO/_pages/tutorial/04_python_script.html" />
<meta property="og:url" content="http://localhost:4000/CDEFO/_pages/tutorial/04_python_script.html" />
<meta property="og:site_name" content="CDEFO" />
<script type="application/ld+json">
{"url":"http://localhost:4000/CDEFO/_pages/tutorial/04_python_script.html","headline":"Setting Up the Python Script","description":"The Premiere Emotional UbiComp Emulator","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <link rel="stylesheet" href="/CDEFO/assets/css/style.css?v=">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">CDEFO</h1>
      <h2 class="project-tagline">The Premiere Emotional UbiComp Emulator</h2>
      	<a href="/CDEFO/" class="btn">Home</a>
		<a href="/CDEFO/about/" class="btn">About</a>
		<a href="/CDEFO/doc/" class="btn">Docs</a>
		<a href="/CDEFO/tut/" class="btn">Tutorial</a>
		<a href="/CDEFO/log/" class="btn">Build Log</a>
	  
	  <a href="/CDEFO/blog/" class="btn">Blog</a>
      
    </section>

    <section class="main-content">
      <h1>Setting Up the Python Script</h1>
 
    <p>After ignoring the Python script for so long, we’re finally going to use it.</p>

<p>Assuming you have Python installed already, all you need to do is enter your command line of choice, <code class="highlighter-rouge">cd \path\to\the\script\and\setup.py</code>, and run, <code class="highlighter-rouge">python setup.py install</code>. 
For anyone knew to python, what this does is sets up the Python script along with all of its dependencies as a module that can run on its own (it still uses the PYthon interpreter, though),
It just makes it so all of the dependencies it needs are in its directory and you don’t need to worry about installing them yourself or making a virtual environment.</p>

<p>Again, the more observant among you will note that this python script has nearly the same format as the driver. 
The Python Script has one continuously running Thread Class that reads from the serial port and has a series of if statements that each line can satisfy.</p>

<p>Any other threads that I create are used to run things like Webbrowsers and GUI elements without blocking the read.</p>

<p><strong>Warning: If you modify the Python Script to use blocking functions, it will stop the Arduino from executing,
since the Arduino will wait for its Serial.output to be read before continuing, no matter what its doing.</strong></p>

<p>Here’s the <code class="highlighter-rouge">handle_data</code> function from the <code class="highlighter-rouge">SerialThread</code> class which demonstrates how closely the driver and script resemble each other.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reading</span>
        <span class="k">if</span> <span class="s">"Firmware ver. 1.6"</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">gui_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="s">"Welcome to the Capstone Fair!"</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">experience</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="s">"Maybe it'd be interesting to put one of the objects on the receiver?"</span><span class="p">)</span>
            <span class="n">gui_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s">""</span>

        <span class="k">if</span> <span class="s">"place a tag."</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s">""</span>

        <span class="k">if</span> <span class="s">":L:"</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"found lights"</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s">""</span>

        <span class="c1"># the text that describes the experience is updated when the videos and images are
</span>        <span class="k">if</span> <span class="s">":V:"</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="p">((</span><span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">":V:"</span><span class="p">,</span> <span class="s">"text_"</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">".txt"</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">gui_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="n">w</span><span class="o">.</span><span class="n">experience</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">"1.0"</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
                <span class="n">w</span><span class="o">.</span><span class="n">experience</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">INSERT</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">w</span><span class="o">.</span><span class="n">toggle_video</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">":V:"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="n">gui_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">":P:"</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="p">((</span><span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">":P:"</span><span class="p">,</span> <span class="s">"text_"</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">".txt"</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">gui_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="n">w</span><span class="o">.</span><span class="n">experience</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">"1.0"</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
                <span class="n">w</span><span class="o">.</span><span class="n">experience</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">INSERT</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">w</span><span class="o">.</span><span class="n">toggle_picture</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">":P:"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="n">gui_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">":Pl:"</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">winsound</span><span class="o">.</span><span class="n">PlaySound</span><span class="p">((</span><span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">":Pl:"</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">winsound</span><span class="o">.</span><span class="n">SND_ASYNC</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">":W:"</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"parsing website:"</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s">""</span>

        <span class="k">if</span> <span class="s">":We:"</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">gui_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">experience</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="s">"going to website:"</span> <span class="o">+</span> <span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">":We:"</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span>
            <span class="n">gui_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">webbrowser</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">":We:"</span><span class="p">,</span> <span class="s">""</span><span class="p">),</span> <span class="n">autoraise</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s">""</span>

        <span class="k">if</span> <span class="s">":S:"</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">gui_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">experience</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="s">"Searching for Spotify artist:"</span> <span class="o">+</span> <span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">":S:"</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span>
            <span class="n">gui_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="c1"># print("searching for Spotify artist:")
</span>            <span class="c1"># print(out.replace(":S:", ""))
</span>            <span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">":S:"</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s">'tracks'</span><span class="p">][</span><span class="s">'items'</span><span class="p">]:</span>
                <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s">'name'</span><span class="p">],</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s">'external_urls'</span><span class="p">][</span><span class="s">'spotify'</span><span class="p">])</span>

            <span class="n">trim</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">'tracks'</span><span class="p">][</span><span class="s">'items'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'external_urls'</span><span class="p">][</span><span class="s">'spotify'</span><span class="p">]</span>

            <span class="n">x</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">webbrowser</span><span class="o">.</span><span class="n">open_new</span><span class="p">(</span><span class="n">trim</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"'"</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s">""</span>

        <span class="k">if</span> <span class="s">":End:"</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s">""</span>

        <span class="k">if</span> <span class="s">"Cleanup finished :Stop:"</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">gui_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">experience</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
            <span class="n">gui_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></code></pre></figure>

<p>The Python script here pretty much handles everything that the Arduino can’t,
such as Audio/Video playback, and serving large amounts of text that would normally crash an Arduino</p>

<p>When it comes to this script, there are only three things to note:</p>
<ol>
  <li>Running the script with the Arduino plugged acts like a Serial Console and reset the Arduino, this is useful if there is an unexpected crash, or you wish to sync the Arduino and script together (which is absolutely intended)</li>
  <li>Any files that you plan on serving with the script <strong>must</strong> be in the same directory as the script. The naming scheme is also very strict, and the <code class="highlighter-rouge">file_name</code> should be kept short so as to fit on an NFC tag.</li>
  <li>Text files are displayed alongside photos or videos (<code class="highlighter-rouge">:P:</code> and <code class="highlighter-rouge">:V:</code> respectively) and they must follow the naming convention “text_{AV_file_name}.txt”</li>
</ol>

<p>An example of the Python script working together the Arduino can be seen in one of the demonstrations I prepared for the Capstone Fair.
Here is the story of John Fitzell’s Hedgehog.
<!-- Feel free to change the width and height to your desired video size. --></p>

<div class="embed-container">
  <iframe width="700" height="480" src="https://www.youtube.com/embed/SxYcZkiHW9E" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>Looking at the directory tree where I had the script running, along with the commands I had written to the NFC tag help to demystify what (3) in particular means.</p>

<figure>
        <img src="/CDEFO/_assets/images/Directory_Python.jpg" />
        <figcaption>See, looks how bad these pads got. They literally have holes in them and you don't even know it until you pry them off manually</figcaption>
</figure>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Place an NFC Tag that you want to Record these Messages on!"</span><span class="p">);</span> <span class="c1">// Command for the Serial Monitor</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nfc</span><span class="p">.</span><span class="n">tagPresent</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">NdefMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">NdefMessage</span><span class="p">();</span>
        <span class="n">message</span><span class="p">.</span><span class="n">addTextRecord</span><span class="p">(</span><span class="s">":Pl:TurtleA.wav"</span><span class="p">);</span>
        <span class="n">message</span><span class="p">.</span><span class="n">addTextRecord</span><span class="p">(</span><span class="s">":V:TurtleV.mp4"</span><span class="p">);</span>
        <span class="n">message</span><span class="p">.</span><span class="n">addTextRecord</span><span class="p">(</span><span class="s">"B:L:bBT;yTB;tTB"</span><span class="p">);</span>
        <span class="n">message</span><span class="p">.</span><span class="n">addTextRecord</span><span class="p">(</span><span class="s">":Stop:"</span><span class="p">);</span>
        <span class="n">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="n">nfc</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Good Job, the experience is now ready!"</span><span class="p">);</span> <span class="c1">// if it works you will see this message </span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Write failed"</span><span class="p">);</span> <span class="c1">// If the the rewrite failed you will see this message</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The second <code class="highlighter-rouge">TextRecord</code> recorded in this experience is <code class="highlighter-rouge">":V:TurtleV.mp4"</code> and according to the naming convention defined in (3),
this means that the text that the script will try to serve will be named <code class="highlighter-rouge">"text_TurtleV.txt"</code>.</p>

<p>Other than this, it’s really only pertinent to let you know that the Python script is signficantly more stable than the Arduino,
simply because of how fragile the Arduino are and how picky they are when it comes to the proper working conditions. This last experience I showed you was recorded moments after this…</p>

<!-- Feel free to change the width and height to your desired video size. -->

<div class="embed-container">
  <iframe width="700" height="480" src="https://www.youtube.com/embed/YiPeeaX3jfE" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>In this experience, I have an EQ running (covered in the docs) along with the regular Mood Lighting scripts and the Python script. 
You can see at the beginning the script actually restarts in the middle because in the process of running the LEDs and the NFC readers at the same time, 
the Arduino hard resets for an unknown reason. From what I’ve gathered, though, it has something to do with the quality of the ground on the DC Power Supply that I use to power the LEDs 
(which is odd, since the Arduino isn’t even connected to the power through there, it’s only grounded through it.</p>












      <footer class="site-footer">
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
		<span class="site-footer-contact"><a href="/CDEFO/contact">Contact Page</a>.</span>
	  </footer>
    </section>

    
  </body>
</html>
